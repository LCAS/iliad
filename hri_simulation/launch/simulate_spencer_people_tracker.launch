<?xml version="1.0"?>


<!--  
        We are having issues making people detector to work under simulation.
        This is a shortcut to work on human aware navigation: I use Timm's ground truth tracks to feed the tracker
        and obtain a tracked person topic.
        No filtering, no oclusions. This is mostly to get a continuous tracked person output.
-->

<launch>

    <arg name="robot_id" default="4"/>    

    <!-- These are not likely to be changed ever...  -->
    <arg name="prefix" default="robot$(arg robot_id)"/>
    <arg name="topic_prefix" default="/$(arg prefix)"/>
    <arg name="initiation_logic_param_file" default="logic_initiator.yaml"/>
    <arg name="ekf_param_file" default="ekf_default.yaml"/>
    <arg name="queue_size" value="5" />
    <arg name="data_association_type" default="greedy_nearest_neighbor"/>

    <group ns="$(arg prefix)">
        <!-- People detector: FAKE IT! -->
        <node name="groundtruth_tracks_from_gazebo" pkg="iliad_human_perception_launch" type="groundtruth_tracks_from_gazebo.py" respawn="true">
              <remap from="/groundtruth/detected_persons" to="$(arg topic_prefix)/perception/detected_persons" />
        </node>  

        <!-- People tracker -->
        <node name="srl_nearest_neighbor_tracker" type="nnt_node" pkg="srl_nearest_neighbor_tracker" output="screen" clear_params="true" launch-prefix=""> 
            <!-- Topic of secondary low-confidence detections that can be matched against an existing track, but not initiate a new one -->

            <remap from="/spencer/perception/detected_persons" 
                    to="$(arg topic_prefix)/perception/detected_persons"/>
            <remap from="/spencer/perception/tracked_persons" 
                    to="$(arg topic_prefix)/perception/tracked_persons"/>

           
            <param name="world_frame" value="world"/>
            <param name="min_distance_for_low_confidence_observations_to_tracks" value="0.5"/>
            <param name="min_num_matches_to_allow_low_confidence_match" value="10"/>
            <param name="max_consecutive_low_confidence_matches" value="60"/>
            <param name="max_timestamp_difference_for_missed_observation_recovery" value="0.07"/>

            <!-- Publisher and subscriber queue lengths -->
            <param name="queue_size" value="$(arg queue_size)"/>

            <!-- Only used when publishing tracks, to take latencies into account -->
            <param name="published_track_forward_predict_time" value="0.10"/>

            <!-- Gating -->
            <param name="max_gating_distance" value="1.0"/>
            <param name="use_correlation_log" value="false"/>
            
            <!-- Data Association -->
            <param name="data_association_type" value="$(arg data_association_type)"/>
            
            <!-- Occlusion handling -->
            <rosparam file="$(find srl_nearest_neighbor_tracker)/launch/params/occlusion_manager_basic_timm.yaml" command="load"/>
            
            <!-- History of track states for duplicate elimination and debugging -->
            <param name="state_history_length" value="30"/>

            <!-- Duplicate track elimination -->
            <param name="duplicate_track_num_history_entries_to_compare" value="5"/>
            <param name="duplicate_track_num_history_entries_must_match" value="3"/>
            <param name="duplicate_track_max_dist" value="0.15"/>

            <!-- Track initiation -->
            <rosparam file="$(find srl_nearest_neighbor_tracker)/launch/params/$(arg initiation_logic_param_file)" command="load"/>
            <param name="use_initiation_logic" value="true"/>
           
            <!-- Default Kalman filter parameters -->
            <rosparam file="$(find srl_nearest_neighbor_tracker)/launch/params/$(arg ekf_param_file)" command="load"/>
            
            <!-- Override measurement noise values from detectors -->
            <param name="overwrite_measurement_noise" value="false"/>
            <param name="measurement_noise" value="0.05"/>

            <!-- Settings to reproduce results of ICRA16 paper (disable features that were added afterwards) -->
            <param name="logic_initiator_high_confidence_modalities" value=""/>
            <param name="published_track_forward_predict_time" value="0.0"/>
        </node>


    </group>

</launch> 



